<!-- Generated by SpecStory, Markdown v2.1.0 -->

<!-- vscode Session 3807166f-d3fa-4cd1-9adf-fb12229d1580 (2026-02-24 03:06Z) -->

# Performance and Logic Issues in Calendar Hierarchy Code (2026-02-24 03:06Z)

_**User (2026-02-24 03:06Z)**_

### [IMPORTANT] Performance: Repeated Regex Compilation
**File:** crates/core/src/resolver/expander.rs, crates/core/src/resolver/context.rs
**Line:** expander.rs:161, context.rs:55
**Issue:** Regexes for calendar level identifier patterns are recompiled on every call to `infer_period_level` (inside a loop over children) and `find_period_level` (per request). This violates success criteria SC-006 (performance) as it scales poorly with hierarchy depth and child count.
**Suggested fix:** Cache compiled regexes. Since `Calendar` is immutable in this context, consider creating a `CalendarMatcher` struct that compiles all level patterns once during initialization and reusing it, or use `once_cell` / `lazy_static` if patterns were static (though they are dynamic configuration, so a struct is better).

### [IMPORTANT] Logic: Potential Infinite Recursion in Hierarchy Check
**File:** crates/core/src/resolver/expander.rs
**Line:** 141-150
**Issue:** `is_descendant_level` iterates up the parent hierarchy using `while let Some(level_name) = current`. If the calendar definition contains a cycle (e.g., A -> B -> A), this loop will not terminate. The spec assumption "Calendar hierarchy definitions ... include stable child ordering" implies a DAG, but the code should be defensive.
**Suggested fix:** Add a `visited` HashSet to detect cycles in `is_descendant_level`, similar to how `collect_descendants_at_level` handles it.



---

_**Agent (model copilot/gpt-5.3-codex)**_

<tool-use data-tool-type="task" data-tool-name="manage_todo_list">
<details>
<summary>Tool use: **manage_todo_list** • Manage and track todo items</summary>

**Created 4 todos**

- [-] Inspect resolver regex usage
- [ ] Implement regex matcher caching
- [ ] Add cycle guard in ancestry check
- [ ] Run targeted resolver tests

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="copilot_readFile">
<details>
<summary>Tool use: **copilot_readFile** • Reading [](file:///home/marcos/Projects/.worktrees/dobonomodo-S11/crates/core/src/resolver/expander.rs)</summary>


Read [](file:///home/marcos/Projects/.worktrees/dobonomodo-S11/crates/core/src/resolver/expander.rs)

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="copilot_readFile">
<details>
<summary>Tool use: **copilot_readFile** • Reading [](file:///home/marcos/Projects/.worktrees/dobonomodo-S11/crates/core/src/resolver/context.rs#1-1), lines 1 to 220</summary>


Read [](file:///home/marcos/Projects/.worktrees/dobonomodo-S11/crates/core/src/resolver/context.rs#1-1), lines 1 to 220

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="copilot_readFile">
<details>
<summary>Tool use: **copilot_readFile** • Reading [](file:///home/marcos/Projects/.worktrees/dobonomodo-S11/crates/core/src/resolver/context.rs#220-220), lines 220 to 226</summary>


Read [](file:///home/marcos/Projects/.worktrees/dobonomodo-S11/crates/core/src/resolver/context.rs#220-220), lines 220 to 226

</details>
</tool-use>

---

<tool-use data-tool-type="search" data-tool-name="copilot_findTextInFiles">
<details>
<summary>Tool use: **copilot_findTextInFiles** • Searching for regex `find_period_level\(|infer_period_level\(|identifier_pattern|Regex::new\(` (`**/crates/core/src/resolver/**`)</summary>


Searched for regex `find_period_level\(|infer_period_level\(|identifier_pattern|Regex::new\(` (`**/crates/core/src/resolver/**`), 16 results

</details>
</tool-use>

---

<tool-use data-tool-type="unknown" data-tool-name="copilot_listDirectory">
<details>
<summary>Tool use: **copilot_listDirectory**</summary>


Parameters:

```json
{
  "file_path": "home/marcos/Projects/.worktrees/dobonomodo-S11/crates/core/src/resolver",
  "relativeWorkspacePath": "resolver"
}
```
Additional data:

```json
{
  "vscodeToolId": "copilot_listDirectory",
  "isHidden": false
}
```
Result:

```json
{
  "invocationMessage": "Reading [](file:///home/marcos/Projects/.worktrees/dobonomodo-S11/crates/core/src/resolver)",
  "pastTenseMessage": "Read [](file:///home/marcos/Projects/.worktrees/dobonomodo-S11/crates/core/src/resolver)",
  "isConfirmed": {
    "type": 1
  },
  "content": "",
  "textEditContent": "",
  "toolCallResult": null
}
```
Status: **completed**


</details>
</tool-use>

---

**Planning multi-file fixes**I’m going to inspect the resolver code paths you flagged, then patch both the regex compilation hotspot and the hierarchy traversal to be cycle-safe. After edits, I’ll run targeted tests for resolver behavior to verify no regressions.**Considering parallel file reads**I’m gathering the exact implementation details in both files so I can make minimal, style-consistent changes.**Scoping shared calendar matcher**I found both hot paths and confirmed they compile `Regex` repeatedly in loops; next I’ll add a reusable matcher type and switch both call sites to it, preserving current error behavior where needed.**Exploring resolver directory layout**

---

